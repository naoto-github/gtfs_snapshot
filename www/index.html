<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
  <script src="components/loader.js"></script>
  <script src="lib/onsenui/js/onsenui.min.js"></script>

  <!-- CDN for Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
    integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
    integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
    crossorigin=""></script>

  <link rel="stylesheet" href="components/loader.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsenui.css">
  <link rel="stylesheet" href="css/onsen-css-components.css">
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/style.css">

  <!-- CLASS -->
  <script src="RouteClass.js"></script>

  <!-- GTFS -->
  <script src="json/stops.js"></script>
  <script src="json/routes.js"></script>
  <script src="json/shapes.js"></script>

  <script>

    // 地図
    var map;

    // バス停
    var stops = new Array();

    // 経路
    var routes = new Array();

    // トップページの初期化
    function initTop(){
      console.log("init top.html");
    }

    // 地図ページの初期化
    function initMap(){
      console.log("init map.html");

      // 緯度経度と倍率
      var center = L.latLng(35.130621, 137.037568);
      var zoom = 15;

      map = L.map("map");
      map.setView(center, zoom);

      L.tileLayer(
        "http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          attribution: "&copy; <a href='http://osm.org/copyright'>OpenStreetMap</a> contributors"
        }
      ).addTo(map); 
    }

    // バス停の表示
    function showStops(){
      for(var i=0; i<stops_data.length; i++){
        // console.log(stops_data[i].stop_name + " " + stops_data[i].stop_lat + " " + stops_data[i].stop_lon);
        var marker = L.marker([stops_data[i].stop_lat, stops_data[i].stop_lon],
        {
          title: stops_data[i].stop_name,
          opacity: 0.8
        });
        marker.bindPopup("<p>" + stops_data[i].stop_name + "</p>");
        marker.addTo(map);
        stops.push(marker);
      }
    }

    // 経路の表示
    function showShapes(){

      // バス路線パターンの取得
      var route_patterns = new Array();
      for(var i=0; i<shapes_data.length; i++){
        shape_id = shapes_data[i].shape_id;
        if(route_patterns.indexOf(shape_id) == -1){
          route_patterns.push(shape_id);
        }
      }

      // console.log("pattern: " + route_patterns);

      // バス経路の取得
      for(var i=0; i<route_patterns.length; i++){

        var shape = shapes_data.filter(function(shape, index){
          if(shape.shape_id == route_patterns[i]){
            return shape;
          }
        });

        var route = new RouteClass(route_patterns[i]);
        route.route = shape;
        routes.push(route);

        // console.log(route.id + " " + route.length);
      }

      // バス路線名の設定
      for(var i=0; i<routes.length; i++){
        id = routes[i].id;
        // console.log("route: " + routes[i].id + " " + routes[i].name);
        for(var j=0; j<routes_data.length; j++){
          // console.log("route: " + routes[i].id + " " + routes_data[i].route_name);
          if(id.indexOf(routes_data[j].route_id) === 0){
            routes[i].name = routes_data[j].route_short_name;
          }
        }

        // console.log(routes[i].id + " " + " " + routes[i].name + " " + routes[i].route.length);
      }

      // 経路の描画
      for(var i=0; i<routes.length; i++){
        var latlngs = new Array();
        for(var j=0; j<routes[i].route.length; j++){
          latlngs.push([routes[i].route[j].shape_pt_lat, routes[i].route[j].shape_pt_lon]);
        }
        var line = new L.polyline(latlngs);
        line.addTo(map);
      }
    }

    ons.ready(function() {

      // ナビゲータの取得
      var navigator = document.getElementById('navigator');

      document.addEventListener('init', function(event){
        var page = event.target;

        console.log("ID: " + page.id);

        if(page.id == "top-page") {
          initTop();
        } 
        else if(page.id == "map-page") {
          initMap();
          showStops();
          showShapes();
        }
      });

      $("#start").click(function(){
        navigator.pushPage("map.html");
      });

    });
  </script>
</head>
<body>

  <ons-navigator id="navigator" page="top.html"></ons-navigator>

  <ons-template id="top.html">
    <ons-page id="top-page">

      <ons-toolbar>
        <div class="center">GTFS Snapshot</div>
      </ons-toolbar>

      <div id="main">

        <div id="title">
          <h1>日進市GTFSから</h1> 
          <h1>バスロケを予測</h1>
        </div>

        <ons-button id="start" modifier="large--cta">
          <p style="font-size:30px; margin-top:5px;">スタート</p>
        </ons-button>

      </div>

    </ons-page>
  </ons-template>

  <ons-template id="map.html">
    <ons-page id="map-page">

      <ons-toolbar>
        <div class="left"><ons-back-button>TOP</ons-back-button></div>
        <div class="center">GTFS Snapshot</div>
      </ons-toolbar>

      <div id="map"></div>
    </ons-page>
  </ons-template>

</body>
</html>
